(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[108],{4595:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/student/instant-attendance",function(){return t(3215)}])},3215:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return StudentInstantAttendance}});var a=t(5893),n=t(7294),r=t(3022),l=t(4970),c=t.n(l),i=t(6266),o=t(8815),d=t(6501),u=t(7066),m=t(3756),g=t(3777),x=t(6609),h=t(9455),f=t(5041),b=t(713),p=t(4464),y=t(3219),j=t(7653),w=t(5077);function StudentInstantAttendance(){var e;let{currentUser:s}=(0,i.a)(),t=(0,n.useRef)(null),[l,v]=(0,n.useState)(""),[N,k]=(0,n.useState)(!1),[D,P]=(0,n.useState)(null),[C,S]=(0,n.useState)(1),[I,Z]=(0,n.useState)(null),[E,F]=(0,n.useState)(!1),[A,_]=(0,n.useState)("user"),[z,T]=(0,n.useState)(0),[L,q]=(0,n.useState)({faceDetected:!1,faceSize:!1,lighting:!1,headPose:!1,eyesOpen:!1}),[B,O]=(0,n.useState)(!1),[R,M]=(0,n.useState)(0),[Y,Q]=(0,n.useState)("Position your face in the circle"),[V,K]=(0,n.useState)({blur:0,brightness:0}),[U,H]=(0,n.useState)(0),[X,G]=(0,n.useState)(0);async function handlePasswordSubmit(e){e.preventDefault();let t=Date.now();if(N||t-U<2e3){console.log("Submission blocked - too soon or already submitting");return}if(H(t),!l.trim()){d.ZP.error("Please enter the attendance password");return}let a=l.trim();if(!/^\d{6}$/.test(a)){d.ZP.error("Password must be exactly 6 digits");return}k(!0),P(null);try{let{data:e,error:t}=await o.T.validateInstantPassword(a,s.uid);if(t){let e=t.message;e.includes("expired")?e="Password has expired. Please ask your teacher for a new one.":e.includes("already marked")?e="You have already marked attendance today.":e.includes("not enrolled")?e="You are not enrolled in this class. Please contact your teacher.":e.includes("pending approval")?e="Your enrollment is pending teacher approval.":e.includes("Invalid")||e.includes("invalid")?e="Invalid password. Please check with your teacher.":e.includes("Database connection")&&(e="Connection error. Please try again in a moment."),d.ZP.error(e),P({success:!1,message:e})}else Z(e),S(2),d.ZP.success("Password validated for ".concat(e.class_name,". Please proceed with face recognition."))}catch(s){console.error("Error validating password:",s);let e="Failed to validate password. Please try again.";"TypeError"===s.name&&s.message.includes("fetch")?e="Network error. Please check your internet connection and try again.":s.message.includes("timeout")?e="Request timed out. Please try again.":s.message.includes("NetworkError")&&(e="Network error. Please check your connection."),d.ZP.error(e),P({success:!1,message:e})}finally{k(!1)}}let W=(0,n.useCallback)(async e=>{let t=Date.now();if(E||t-X<3e3){console.log("Capture blocked - too soon or already processing");return}if(G(t),!I){d.ZP.error("Please validate password first");return}if(!(null==s?void 0:s.uid)){d.ZP.error("User not authenticated");return}console.log("\uD83D\uDD04 Starting face recognition process..."),console.log("\uD83D\uDC64 Current user:",s.uid),console.log("\uD83D\uDD11 Validated data:",I),console.log("\uD83D\uDD10 Password:",l),F(!0),P(null);try{console.log("\uD83D\uDCF8 Converting image to blob...");let t=await fetch(e),a=await t.blob();console.log("✅ Image converted to blob, size:",a.size);let n=new FormData;n.append("image",a,"face.jpg"),n.append("user_id",s.uid),console.log("\uD83D\uDCE4 Sending face recognition request for user:",s.uid),console.log("\uD83D\uDCE4 Making API call to:","".concat("http://localhost:8000","/recognize"));let r=await Promise.race([u.Z.post("".concat("http://localhost:8000","/recognize"),n,{headers:{"Content-Type":"multipart/form-data"},timeout:3e4}),new Promise((e,s)=>setTimeout(()=>s(Error("Face recognition timeout after 30 seconds")),3e4))]);if(console.log("\uD83D\uDCE5 Face recognition response:",r.data),r.data.success&&r.data.recognized){console.log("✅ Face recognized, marking attendance...");let{data:e,error:t}=await o.T.markInstantAttendance(l,s.uid);if(console.log("\uD83D\uDCE5 Attendance marking response:",{data:e,error:t}),t){console.error("❌ Attendance marking failed:",t);let e=t.message;e.includes("expired")?e="Password has expired during face recognition. Please ask your teacher for a new one.":e.includes("already marked")&&(e="Attendance was already marked during face recognition."),d.ZP.error(e),P({success:!1,message:e})}else{console.log("\uD83C\uDF89 Attendance marked successfully!");let s="Attendance marked successfully for ".concat(I.class_name,"!");d.ZP.success("\uD83C\uDF89 ".concat(s),{duration:4e3,style:{background:"#10B981",color:"white",fontWeight:"bold",padding:"16px",borderRadius:"12px"}}),P({success:!0,data:{...e,class_name:I.class_name},message:s}),setTimeout(()=>{v(""),S(1),Z(null),resetLiveness()},2e3)}}else{console.log("❌ Face recognition failed:",r.data);let e="Face recognition failed. Please try again.";r.data.liveness_check?r.data.recognized||(e="Face not recognized. Please ensure your face is enrolled and try again."):e=r.data.message||"Liveness check failed. Please ensure you are a real person.",d.ZP.error(e),P({success:!1,message:e})}}catch(s){console.error("\uD83D\uDCA5 Error during face recognition:",s);let e="Face recognition failed. Please try again.";if("ECONNABORTED"===s.code||s.message.includes("timeout"))e="Face recognition timed out. Please try again.";else if(s.response){var a;console.error("Server error response:",s.response.data),e=(null===(a=s.response.data)||void 0===a?void 0:a.message)||"Server error during face recognition."}else s.request?(console.error("No response received:",s.request),e="Network error during face recognition. Please check your connection."):(console.error("Unexpected error:",s.message),e="Unexpected error during face recognition. Please try again.");d.ZP.error(e),P({success:!1,message:e})}finally{console.log("\uD83D\uDD04 Face recognition process completed, resetting processing state"),F(!1)}},[l,null==s?void 0:s.uid,I]);function goBackToPassword(){S(1),Z(null),P(null),resetLiveness()}(0,n.useEffect)(()=>{if(1===z){let e=setInterval(()=>{q(e=>{let s={...e};return s.faceDetected?s.faceSize?s.lighting?s.headPose?s.eyesOpen||(s.eyesOpen=!0,Q("Eyes detected! Now please blink naturally"),T(2),startBlinkDetection()):(s.headPose=!0,Q("Perfect head position. Keep your eyes open naturally")):(s.lighting=!0,Q("Lighting looks good. Please face the camera directly")):(s.faceSize=!0,Q("Good face size. Checking lighting...")):(s.faceDetected=!0,Q("Face detected! Keep looking at the camera")),s})},1e3);return()=>clearInterval(e)}},[z]);let startBlinkDetection=()=>{M(3);let e=setInterval(()=>{M(s=>s<=1?(clearInterval(e),setTimeout(()=>{O(!0),Q("Blink detected! Capturing image..."),T(3),setTimeout(()=>{J()},1e3)},1e3),0):s-1)},1e3)},$=(0,n.useCallback)(e=>new Promise(s=>{let t=new Image;t.onload=()=>{let e=document.createElement("canvas"),a=e.getContext("2d");e.width=t.width,e.height=t.height,a.drawImage(t,0,0);let n=a.getImageData(0,0,e.width,e.height),r=n.data,l=0;for(let e=0;e<r.length;e+=4)l+=(r[e]+r[e+1]+r[e+2])/3;l/=r.length/4;let c=0;for(let e=0;e<r.length-4;e+=4){let s=Math.abs(r[e]+r[e+1]+r[e+2]-(r[e+4]+r[e+5]+r[e+6]));s>30&&c++}let i=c/(r.length/4);s({brightness:l,sharpness:i})},t.src=e}),[]),J=(0,n.useCallback)(async()=>{console.log("\uD83D\uDCF8 Capture function called");let e=t.current.getScreenshot({width:1280,height:720,quality:.95});if(e){console.log("\uD83D\uDCF8 Image captured, checking quality...");let s=await $(e);if(K(s),console.log("\uD83D\uDCCA Image quality:",s),s.brightness<20){console.log("❌ Image too dark"),d.ZP.error("Image too dark. Please improve lighting or move to a brighter area."),resetLiveness();return}if(s.brightness>240){console.log("❌ Image too bright"),d.ZP.error("Image too bright. Please reduce lighting or move away from direct light."),resetLiveness();return}console.log("✅ Image quality acceptable, proceeding to face recognition"),d.ZP.success("Image quality acceptable. Processing attendance...",{duration:2e3,style:{background:"#10B981",color:"white"}}),W(e)}else console.log("❌ No image captured from webcam")},[$,W]),ee=(0,n.useCallback)(()=>{_(e=>"user"===e?"environment":"user")},[]),resetLiveness=()=>{T(0),q({faceDetected:!1,faceSize:!1,lighting:!1,headPose:!1,eyesOpen:!1}),O(!1),M(0),Q("Position your face in the circle")},getCheckIcon=e=>e?(0,a.jsx)(m.Z,{className:"h-4 w-4 text-green-500"}):(0,a.jsx)("div",{className:"h-4 w-4 rounded-full border-2 border-gray-300"});return(0,a.jsx)(r.Z,{children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto space-y-8",children:[(0,a.jsxs)("div",{className:"bg-gradient-to-r from-blue-600 to-green-600 rounded-2xl p-8 text-white text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm mx-auto mb-4",children:(0,a.jsx)(g.Z,{className:"h-8 w-8 text-white"})}),(0,a.jsx)("h1",{className:"text-4xl font-bold mb-2",children:"Quick Attendance"}),(0,a.jsx)("p",{className:"text-blue-100 text-lg",children:1===C?"Enter the password provided by your teacher":"Complete face recognition to mark attendance"}),(0,a.jsxs)("div",{className:"flex items-center justify-center mt-6 space-x-4",children:[(0,a.jsxs)("div",{className:"flex items-center ".concat(C>=1?"text-white":"text-blue-300"),children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ".concat(C>=1?"bg-white text-blue-600":"bg-blue-400 text-white"),children:"1"}),(0,a.jsx)("span",{className:"ml-2 text-sm",children:"Password"})]}),(0,a.jsx)("div",{className:"w-8 h-0.5 bg-blue-300"}),(0,a.jsxs)("div",{className:"flex items-center ".concat(C>=2?"text-white":"text-blue-300"),children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ".concat(C>=2?"bg-white text-blue-600":"bg-blue-400 text-white"),children:"2"}),(0,a.jsx)("span",{className:"ml-2 text-sm",children:"Face Recognition"})]})]})]}),1===C&&(0,a.jsxs)("div",{className:"bg-white rounded-2xl shadow-lg border border-gray-100 p-8",children:[(0,a.jsxs)("div",{className:"text-center mb-6",children:[(0,a.jsx)(x.Z,{className:"h-12 w-12 text-blue-600 mx-auto mb-4"}),(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Enter Attendance Password"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Your teacher will provide a 6-digit password that's valid for 3 minutes"})]}),(0,a.jsxs)("form",{onSubmit:handlePasswordSubmit,className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Attendance Password"}),(0,a.jsx)("input",{type:"text",value:l,onChange:e=>v(e.target.value.replace(/\D/g,"").slice(0,6)),className:"w-full px-4 py-3 border border-gray-300 rounded-xl text-center text-2xl font-mono tracking-wider focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"000000",maxLength:"6",required:!0}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-1 text-center",children:"Enter the 6-digit code provided by your teacher"})]}),(0,a.jsx)("button",{type:"submit",disabled:N||6!==l.length||Date.now()-U<2e3,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:N?(0,a.jsxs)("div",{className:"flex items-center justify-center",children:[(0,a.jsx)("div",{className:"loading-spinner mr-2 h-5 w-5"}),"Validating Password..."]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(x.Z,{className:"h-5 w-5 mr-2 inline"}),"Validate Password"]})})]})]}),2===C&&I&&(0,a.jsxs)("div",{className:"bg-white rounded-2xl shadow-lg border border-gray-100 p-8",children:[(0,a.jsxs)("div",{className:"text-center mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-center mb-4",children:[(0,a.jsx)(h.Z,{className:"h-12 w-12 text-green-600 mr-2"}),(0,a.jsx)(f.Z,{className:"h-12 w-12 text-blue-600"})]}),(0,a.jsx)("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Face Recognition"}),(0,a.jsxs)("p",{className:"text-gray-600 mb-2",children:["Password validated for ",(0,a.jsx)("span",{className:"font-semibold text-blue-600",children:I.class_name})]}),(0,a.jsx)("p",{className:"text-sm text-gray-500",children:"Please complete face recognition to mark your attendance"})]}),(0,a.jsx)("div",{className:"max-w-2xl mx-auto",children:(0,a.jsxs)("div",{className:"webcam-container",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(c(),{ref:t,audio:!1,screenshotFormat:"image/jpeg",screenshotQuality:.95,videoConstraints:{width:{ideal:1280,min:640},height:{ideal:720,min:480},facingMode:A,frameRate:{ideal:30,min:15},aspectRatio:16/9,advanced:[{focusMode:"continuous"},{exposureMode:"continuous"},{whiteBalanceMode:"continuous"}]},className:"w-full h-auto rounded-lg",style:{filter:"contrast(1.1) brightness(1.05)",imageRendering:"crisp-edges"}}),(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,a.jsx)("div",{className:"w-64 h-64 border-4 border-blue-500 rounded-full border-dashed opacity-70"})}),(0,a.jsx)("button",{onClick:ee,className:"absolute top-4 right-4 p-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-70 transition-all",children:(0,a.jsx)(b.Z,{className:"h-5 w-5"})})]}),(0,a.jsxs)("div",{className:"mt-4 text-center",children:[(0,a.jsx)("p",{className:"text-lg font-medium text-gray-900 mb-2",children:Y}),R>0&&(0,a.jsx)("div",{className:"text-3xl font-bold text-blue-600",children:R})]}),z>0&&(0,a.jsxs)("div",{className:"mt-4 bg-gray-50 rounded-lg p-4",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-900 mb-3",children:"Liveness Verification"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[getCheckIcon(L.faceDetected),(0,a.jsx)("span",{children:"Face Detected"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[getCheckIcon(L.faceSize),(0,a.jsx)("span",{children:"Face Size"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[getCheckIcon(L.lighting),(0,a.jsx)("span",{children:"Lighting"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[getCheckIcon(L.headPose),(0,a.jsx)("span",{children:"Head Position"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[getCheckIcon(L.eyesOpen),(0,a.jsx)("span",{children:"Eyes Open"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[getCheckIcon(B),(0,a.jsx)("span",{children:"Blink Detected"})]})]})]}),(0,a.jsxs)("div",{className:"mt-6 flex justify-center space-x-4",children:[0===z&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("button",{onClick:()=>{T(1),q({faceDetected:!1,faceSize:!1,lighting:!1,headPose:!1,eyesOpen:!1}),O(!1),Q("Starting liveness detection...")},disabled:E,className:"bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors disabled:opacity-50",children:[(0,a.jsx)(p.Z,{className:"h-4 w-4 mr-2"}),"Start Liveness Check"]}),(0,a.jsxs)("button",{onClick:()=>{console.log("\uD83E\uDDEA Quick test - bypassing liveness detection");let e=t.current.getScreenshot({width:1280,height:720,quality:.95});e&&W(e)},disabled:E,className:"bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors disabled:opacity-50",children:[(0,a.jsx)(f.Z,{className:"h-4 w-4 mr-2"}),"Quick Test (Skip Liveness)"]})]}),z>0&&z<3&&(0,a.jsx)("button",{onClick:resetLiveness,disabled:E,className:"bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:"Reset Check"}),3===z&&!E&&(0,a.jsxs)("div",{className:"flex items-center space-x-2 text-green-600",children:[(0,a.jsx)(m.Z,{className:"h-5 w-5"}),(0,a.jsx)("span",{children:"Processing..."})]}),E&&(0,a.jsxs)("div",{className:"flex items-center space-x-2 text-blue-600",children:[(0,a.jsx)("div",{className:"loading-spinner h-5 w-5"}),(0,a.jsx)("span",{children:"Processing face recognition..."})]})]})]})}),(0,a.jsx)("div",{className:"mt-8 flex justify-center",children:(0,a.jsxs)("button",{onClick:goBackToPassword,className:"bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg",disabled:E,children:[(0,a.jsx)(y.Z,{className:"h-5 w-5 mr-2 inline"}),"Back to Password"]})})]}),D&&(0,a.jsx)("div",{className:"rounded-2xl p-6 ".concat(D.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"),children:(0,a.jsxs)("div",{className:"flex items-center",children:[D.success?(0,a.jsx)(m.Z,{className:"h-6 w-6 text-green-600 mr-3"}):(0,a.jsx)(j.Z,{className:"h-6 w-6 text-red-600 mr-3"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("h3",{className:"font-semibold ".concat(D.success?"text-green-900":"text-red-900"),children:D.success?"Attendance Marked Successfully!":"Attendance Failed"}),(0,a.jsx)("p",{className:"text-sm ".concat(D.success?"text-green-700":"text-red-700"),children:D.success?null===(e=D.data)||void 0===e?void 0:e.message:D.message}),D.success&&D.data&&(0,a.jsxs)("div",{className:"mt-2 text-xs text-green-600",children:[(0,a.jsx)(w.Z,{className:"h-4 w-4 mr-1 inline"}),"Marked at: ",new Date(D.data.marked_at).toLocaleString("en-IN",{timeZone:"Asia/Kolkata",hour12:!0,year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})}),(0,a.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-2xl p-6",children:[(0,a.jsx)("h3",{className:"font-semibold text-blue-900 mb-3",children:"How it works:"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm text-blue-800",children:[(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)("span",{className:"bg-blue-200 text-blue-900 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5",children:"1"}),(0,a.jsx)("span",{children:"Your teacher will generate a 6-digit password during class"})]}),(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)("span",{className:"bg-blue-200 text-blue-900 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5",children:"2"}),(0,a.jsx)("span",{children:"The password is valid for only 3 minutes"})]}),(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)("span",{className:"bg-blue-200 text-blue-900 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5",children:"3"}),(0,a.jsx)("span",{children:"Enter the password to validate your class enrollment"})]}),(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)("span",{className:"bg-blue-200 text-blue-900 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5",children:"4"}),(0,a.jsx)("span",{children:"Complete face recognition to mark your attendance"})]}),(0,a.jsxs)("div",{className:"flex items-start",children:[(0,a.jsx)("span",{className:"bg-blue-200 text-blue-900 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 mt-0.5",children:"5"}),(0,a.jsx)("span",{children:"You can only mark attendance once per day per class"})]})]})]}),(0,a.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-2xl p-6",children:[(0,a.jsx)("h3",{className:"font-semibold text-gray-900 mb-3",children:"Alternative Methods:"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm text-gray-700",children:[(0,a.jsx)("p",{children:"• Ask your teacher to mark attendance manually if face recognition fails"}),(0,a.jsx)("p",{children:"• Contact your teacher if you're having technical difficulties"})]})]})]})})}}},function(e){e.O(0,[701,4,943,22,774,888,179],function(){return e(e.s=4595)}),_N_E=e.O()}]);